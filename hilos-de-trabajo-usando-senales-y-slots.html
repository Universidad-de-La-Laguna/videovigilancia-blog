<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hilos de trabajo usando señales y slots - Sistema de Videovigilancia from Scratch</title>
    <meta name="description" content="">
    <meta name="author" content="Jesús Torres">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="./theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="./theme/bootstrap.min.css" rel="stylesheet">
    <link href="./theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="./theme/local.css" rel="stylesheet">
    <link href="./theme/pygments.css" rel="stylesheet">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href=".">Sistema de Videovigilancia from Scratch</a>

        <div class="nav-collapse">
        <ul class="nav">
                    
                            <li><a href="./pages/acerca-de.html">Acerca de...</a></li>
                    <li><a href="./pages/seminarios.html">Seminarios</a></li>
                        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
            <div class='article'>
        <div class="content-title">
            <h1>Hilos de trabajo usando señales y slots</h1>
            lun 18 febrero 2013

by <a class="url fn" href="./author/jesus-torres.html" rel="author">Jesús Torres</a>
 


        </div>
	
        <div><p><a href="./proyecto-qt-framework-de-desarrollo-de-aplicaciones.html" title="Proyecto Qt">Qt</a> proporciona clases para hilos y mecanismos de sincronización que facilitan
sacar las tareas de larga duración del hilo principal de la aplicación, lo que
de lo contrario bloquearía la interfaz de usuario.</p>
<p>Una forma práctica de hacerlo la hemos visto <a href="./introduccion-al-uso-de-hilos-en-qt.html">anteriormente</a>
utilizando un <em>buffer</em> compartido. Sin embargo <a href="./proyecto-qt-framework-de-desarrollo-de-aplicaciones.html" title="Proyecto Qt">Qt</a> provee a cada hilo de una
cola de mensajes, lo que permite enviar señales a <em>slots</em> en otros hilos. Esto
nos proporciona una forma sencilla de pasar datos entre los hilos de la
aplicación.</p>
<p>Si no se indica lo contrario, las señales emitidas desde un hilo a un objeto
en el mismo hilo son entregadas directamente. Es decir, que al emitir la señal
se invoca el <em>slot</em> como si de un método convencional se tratara. Sin embargo
si el emisor y el receptor residen en hilos diferentes, la señal es insertada
en la cola de mensajes del hilo del objeto de destino. Así el <em>slot</em>
correspondiente será invocado en el hilo receptor desde su bucle de mensajes.</p>
<p>En la actualidad esta es la forma recomendada de usar hilos en <a href="./proyecto-qt-framework-de-desarrollo-de-aplicaciones.html" title="Proyecto Qt">Qt</a> ya que
permite evitar el uso de de mecanismos de sincronización como <a href="http://qt-project.org/doc/qt-5.0/qtcore/qmutex.html" title="QMutex">QMutex</a>,
<a href="http://qt-project.org/doc/qt-5.0/qtcore/qwaitcondition.html" title="QWaitCondition">QWaitCondition</a>, etc.</p>
<h2>El ejemplo. Ordenar números enteros</h2>
<p>El ejemplo que vamos a seguir básicamente consiste en ordenar
un vector de enteros en un hilo de trabajo distinto al hilo principal.</p>
<p>Como se puede observar en la figura utilizaremos dos objetos, uno vinculado
al hilo principal (clase <code>Sorter</code>) y otro al hilo de trabajo
(clase <code>SorterWorker</code>). En una aplicación gráfica convencional con <a href="./proyecto-qt-framework-de-desarrollo-de-aplicaciones.html" title="Proyecto Qt">Qt</a> la
clase <code>Sorter</code> podría ser una ventana o cualquier otro control que
quiera ceder una tarea al hilo de trabajo. Aquí no lo haremos así para
que el ejemplo sea lo más sencillo posible.</p>
<p><img src="https://docs.google.com/drawings/d/1tZ0CMTNJoLsbHx3TjgecQuRXGEM5hf3pYwm9_s1R8bI/pub?w=960&amp;h=720"></p>
<p>En <a href="./proyecto-qt-framework-de-desarrollo-de-aplicaciones.html" title="Proyecto Qt">Qt</a> un objeto se dice que vive en el hilo en el que es creado. Esto se
puede cambiar utilizando el método <a href="http://qt-project.org/doc/qt-5.0/qtcore/qobject.html#moveToThread" title="QObject::moveToThread()">moveToThread</a>() que tienen todas las
clases de <a href="./proyecto-qt-framework-de-desarrollo-de-aplicaciones.html" title="Proyecto Qt">Qt</a><sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h2>La clase Sorter</h2>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">Sorter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QObject</span>
<span class="p">{</span>
    <span class="n">Q_OBJECT</span>

    <span class="k">public</span><span class="o">:</span>
        <span class="n">Sorter</span><span class="p">();</span>
        <span class="o">~</span><span class="n">Sorter</span><span class="p">();</span>

        <span class="c1">// Ordenar asíncronamente un vector en el hilo de trabajo</span>
        <span class="kt">void</span> <span class="n">sortAsync</span><span class="p">(</span><span class="k">const</span> <span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">list</span><span class="p">);</span>

    <span class="nl">signals:</span>
        <span class="c1">// Señal para comunicarnos con el hilo de trabajo</span>
        <span class="kt">void</span> <span class="n">sortingRequested</span><span class="p">(</span><span class="k">const</span> <span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>

    <span class="k">private</span> <span class="nl">slots:</span>
        <span class="c1">// Slot para saber cuando el vector ha sido ordenado</span>
        <span class="kt">void</span> <span class="n">vectorSorted</span><span class="p">(</span><span class="k">const</span> <span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>

    <span class="k">private</span><span class="o">:</span>
        <span class="c1">// Clase del hilo de trabajo</span>
        <span class="n">QThread</span> <span class="n">workingThread_</span><span class="p">;</span>
        <span class="c1">// Clase que hace el ordenamiento</span>
        <span class="n">SorterWorker</span> <span class="n">sorterWorker_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>


<p>La propia clase <code>Sorter</code> se hará cargo de crear el hilo de trabajo, que por
defecto lo único que hace es iterar en su propio bucle de mensajes. Todos
los detalles acerca de la creación de hilos ya los vimos
<a href="./introduccion-al-uso-de-hilos-en-qt.html">anteriormente</a></p>
<p>La clase <code>Sorter</code> provee un método <code>sortAsync()</code> que podrá ser llamado por
los clientes para ordenar un vector de números enteros. Puesto que la operación
es asíncrona, necesitamos definir un <em>slot</em> <code>vectorSorted()</code> para ser
notificados cuando el ordenamiento haya finalizado con éxito.</p>
<p>La implementación de esta clase sería la siguiente:</p>
<div class="codehilite"><pre><span class="n">Sorter</span><span class="o">::</span><span class="n">Sorter</span><span class="p">()</span> <span class="o">:</span> <span class="n">QObject</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">Q_FUNC_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">QThread</span><span class="o">::</span><span class="n">currentThreadId</span><span class="p">();</span>

    <span class="c1">// Registrar los parámetros de la señales. Necesitamos registrar</span>
    <span class="c1">// QList&lt;int&gt; porque no es un tipo conocido por el sistema de</span>
    <span class="c1">// meta-objetos de Qt.</span>
    <span class="n">qRegisterMetaType</span><span class="o">&lt;</span> <span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;QVector&lt;int&gt;&quot;</span><span class="p">);</span>

    <span class="c1">// Pasar la petición de ordenar a la instancia de SorterWorker</span>
    <span class="n">connect</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">SIGNAL</span><span class="p">(</span><span class="n">sortingRequested</span><span class="p">(</span><span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">)),</span>
        <span class="o">&amp;</span><span class="n">sorterWorker_</span><span class="p">,</span> <span class="n">SLOT</span><span class="p">(</span><span class="n">doSort</span><span class="p">(</span><span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">)));</span>
    <span class="c1">// Ser notificado cuando el vector haya sido ordenado</span>
    <span class="n">connect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sorterWorker_</span><span class="p">,</span> <span class="n">SIGNAL</span><span class="p">(</span><span class="n">vectorSorted</span><span class="p">(</span><span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">)),</span>
        <span class="k">this</span><span class="p">,</span> <span class="n">SLOT</span><span class="p">(</span><span class="n">vectorSorted</span><span class="p">(</span><span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">)));</span>

    <span class="c1">// Migrar la instancia de SorterWorker al hilo de trabajo</span>
    <span class="n">sorterWorker_</span><span class="p">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">workingThread_</span><span class="p">);</span>

    <span class="c1">// Iniciar el hilo de trabajo</span>
    <span class="n">workingThread_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">Sorter</span><span class="o">::~</span><span class="n">Sorter</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Le decimos al bucle de mensajes del hilo que se detenga</span>
    <span class="n">workingThread_</span><span class="p">.</span><span class="n">quit</span><span class="p">();</span>
    <span class="c1">// Ahora esperamos a que el hilo de trabajo termine</span>
    <span class="n">workingThread_</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Sorter</span><span class="o">::</span><span class="n">sortAsync</span><span class="p">(</span><span class="k">const</span> <span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">Q_FUNC_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">QThread</span><span class="o">::</span><span class="n">currentThreadId</span><span class="p">();</span>

    <span class="n">emit</span> <span class="n">sortingRequested</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Sorter</span><span class="o">::</span><span class="n">vectorSorted</span><span class="p">(</span><span class="k">const</span> <span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">list</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Como se puede observar, en el constructor de <code>Sorter</code> se usa el método
<code>qRegisterMetaType()</code>, antes de conectar las señales, para registrar el tipo
<code>QVector&lt;int&gt;</code>. Esto debe hacerse porque cuando una señal es encolada sus
parámetros deben ser de tipos conocidos para <a href="./proyecto-qt-framework-de-desarrollo-de-aplicaciones.html" title="Proyecto Qt">Qt</a>, de forma que pueda
almacenar los argumentos en la cola.</p>
<p>Por otro lado en el destructor de <code>Sorter</code> tenemos cuidado de detener
el hilo de trabajo en condiciones seguras cuando ya no va a ser necesario.
Si no lo hacemos así, el hilo podría ser destruido por el sistema operativo
en cualquier punto de la secuencia de instrucciones al termina la aplicación,
lo que podría dejar los datos en uso en un estado indeterminado.</p>
<h2>La clase SorterWorker</h2>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">SorterWorker</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QObject</span>
<span class="p">{</span>
    <span class="n">Q_OBJECT</span>

    <span class="nl">signals:</span>
        <span class="c1">// Señal emitida cuando el vector ha sido ordenado</span>
        <span class="kt">void</span> <span class="n">vectorSorted</span><span class="p">(</span><span class="k">const</span> <span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>

    <span class="k">public</span> <span class="nl">slots:</span>
        <span class="c1">// Método encargado del ordenamiento</span>
        <span class="kt">void</span> <span class="n">doSort</span><span class="p">(</span><span class="k">const</span> <span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">Q_FUNC_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">QThread</span><span class="o">::</span><span class="n">currentThreadId</span><span class="p">();</span>

            <span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">list_sorted</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
            <span class="n">qSort</span><span class="p">(</span><span class="n">list_sorted</span><span class="p">);</span>
            <span class="n">emit</span> <span class="n">vectorSorted</span><span class="p">(</span><span class="n">list_sorted</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">};</span>
</pre></div>


<h2>Como usar el ejemplo</h2>
<p>Para usar el ejemplo sólo necesitamos crear una instancia de <code>Sorter</code> y
llamar a su método <code>sortAsync()</code> para pedir que ordene el vector especificado.</p>
<div class="codehilite"><pre><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">QCoreApplication</span> <span class="n">a</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

    <span class="n">Sorter</span> <span class="n">sorter</span><span class="p">;</span>
    <span class="n">sorter</span><span class="p">.</span><span class="n">sortAsync</span><span class="p">(</span><span class="n">QVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<h2>Referencias</h2>
<ol>
<li><a href="./introduccion-al-uso-de-hilos-en-qt.html">Introducción al uso de hilos en Qt</a></li>
<li><a href="http://cdumez.blogspot.com.es/2011/03/worker-thread-in-qt-using-signals-slots.html">Worker Thread in Qt using Signals &amp; Slots</a></li>
</ol>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Todas las clases de <a href="./proyecto-qt-framework-de-desarrollo-de-aplicaciones.html" title="Proyecto Qt">Qt</a> tienen como clase base <a href="http://qt-project.org/doc/qt-5.0/qtcore/qobject.html" title="QObject">QObject</a> donde se
implementan algunos métodos comunes como <a href="http://qt-project.org/doc/qt-5.0/qtcore/qobject.html" title="QObject">QObject</a>::<a href="http://qt-project.org/doc/qt-5.0/qtcore/qobject.html#moveToThread" title="QObject::moveToThread()">moveToThread</a>()&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
	
        <hr>
    	   
        <h2>Comentarios</h2>
			    <div class="g-comments-for z13vh13yhw3dtz2bs04cddm5vvifuzcyy1g"></div>
    <script src="https://github.com/timrwood/moment/raw/1.7.2/min/moment.min.js"></script>
    <script src="./theme/pluscomments.js"></script>
    <script type="text/javascript">
    function pluscommentsLoad() { pluscomments.load('AIzaSyClPfZd7RRcX9e3eYiOLV__FyRO9RmJzmg'); }
    </script>
    <script src="https://apis.google.com/js/client.js?onload=pluscommentsLoad"></script>
    </div>
        </div>
        
        <div class="span3">

            
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Sitio
                </li>
            
                <li><a href="./archives.html">Archivos</a>
                <li><a href="./tags.html">Etiquetas</a>
                <li><a href="http://ull-etsii-sistemas-operativos.github.com/videovigilancia-blog/feeds/atom.xml" rel="alternate">Fuente Atom</a></li>
                                <li><a href="http://ull-etsii-sistemas-operativos.github.com/videovigilancia-blog/feeds/rss.xml" rel="alternate">Fuente RSS</a></li>
                            </ul>
            </div>


                        <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categorias
                </li>
                
                                <li><a href="./category/comunicaciones.html">Comunicaciones</a></li>
                                <li><a href="./category/hardware.html">Hardware</a></li>
                                <li><a href="./category/linux.html">Linux</a></li>
                                <li><a href="./category/overviews.html">Overviews</a></li>
                                <li><a href="./category/qt.html">Qt</a></li>
                                <li><a href="./category/vision.html">Visión</a></li>
                                   
            </ul>
            </div>
            

            

                        <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                                <li><a href="http://github.com/ull-etsii-sistemas-operativos/">github</a></li>
                                <li><a href="http://plus.google.com/u/0/communities/112085352199958768374">google+</a></li>
                                <li><a href="http://flattr.com/thing/1171169/Sistema-de-videovigilancia-from-scratch">flattr</a></li>
                                <li><a href="http://ull-etsii-sistemas-operativos.github.com/videovigilancia-blog/feeds/atom.xml">atom</a></li>
                                <li><a href="http://ull-etsii-sistemas-operativos.github.com/videovigilancia-blog/feeds/rss.xml">rss</a></li>
                            </ul>
            </div>
            </div>
            
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
<ul class="nav nav-list">
    <li class="nav-header">
    Búsqueda de Google
    </li>

    <script type="text/javascript">
    (function() {
    var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.es/cse/cse.js?cx=' + '013894742475483232300:q2-5a1zlira';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
    })();
    </script>
    <gcse:search>Cargando...</gcse:search>
</ul>
</div>

        </div>  
    </div>     </div> 
<footer>
<br />
<p><a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.es"><img alt="Licencia Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/80x15.png" /></a><br />Este obra está bajo una <a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.es">Licencia Creative Commons Atribución 3.0 Unported</a>.</p>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>
 
</body>
</html>