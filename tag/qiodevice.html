<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>qiodevice - Sistema de Videovigilancia from Scratch</title>
    <meta name="description" content="">
    <meta name="author" content="Jesús Torres">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="../theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="../theme/bootstrap.min.css" rel="stylesheet">
    <link href="../theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="../theme/local.css" rel="stylesheet">
    <link href="../theme/pygments.css" rel="stylesheet">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="..">Sistema de Videovigilancia from Scratch</a>

        <div class="nav-collapse">
        <ul class="nav">
                    
                            <li><a href="../pages/acerca-de.html">Acerca de...</a></li>
                    <li><a href="../pages/seminarios.html">Seminarios</a></li>
                        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
                

        


    <div class='article'>
        <div class="content-title">
            <a href="../uso-de-la-memoria-como-un-dispositivo-de-es.html"><h1>Uso de la memoria como un dispositivo de E/S</h1></a>
            mié 13 marzo 2013

by <a class="url fn" href="../author/jesus-torres.html" rel="author">Jesús Torres</a>
 


 
        </div>
        
        <div><p>Algunas libreras se diseñan específicamente para leer y/o escribir datos en
dispositivos de entrada/salida. Por ejemplo, una librería desarrollada en C++ para
codificar y decodificar archivos MP3 recibiría objetos <a href="http://www.cplusplus.com/reference/istream/istream/" title="std::istream">std::istream</a> o
<a href="http://www.cplusplus.com/reference/ostream/ostream/" title="std::ostream">std::ostream</a> para indicar el flujo del que leer o en el que escribir los datos
respectivamente:</p>
<dl>
<dt><a href="http://www.cplusplus.com/reference/istream/istream/" title="std::istream">std::istream</a></dt>
<dd>Clase de flujo de entrada. Los objetos de esta clase pueden leer e interpretar
la entrada de datos a partir de secuencias de caracteres.</dd>
<dt><a href="http://www.cplusplus.com/reference/ostream/ostream/" title="std::ostream">std::ostream</a></dt>
<dd>Clase de flujo de salida. Los objetos de esta clase pueden escribir secuencias
de caracteres y representar como cadenas otras clases de datos.</dd>
</dl>
<p>Por lo tanto, si deseáramos guardar o recuperar audio codificado en MP3 en un
medio de almacenamiento concreto, necesitaríamos disponer de una clase que nos
ofrezca el acceso al mismo a través de la interfaz de flujos de C++ de
entrada/salida descrita por las clases anteriores.</p>
<p>Objetos como <a href="http://www.cplusplus.com/reference/iostream/cin/" title="std::cin">std::cin</a> y <a href="http://www.cplusplus.com/reference/iostream/cout/" title="std::cout">std::cout</a> son instancias de estas clases, lo que
permitiría que nuestra aplicación codificara y decodificara audio hacia y
desde la entrada/salida estándar del proceso. Lo mismo ocurre con
<a href="http://www.cplusplus.com/reference/fstream/ifstream/" title="std::ifstream">std::ifstream</a>, <a href="http://www.cplusplus.com/reference/fstream/ofstream/" title="std::ofstream">std::ofstream</a> y <a href="http://www.cplusplus.com/reference/fstream/fstream/" title="std::fstream">std::fstream</a>; que heredan de las clases
anteriores e implementan la interfaz de flujos de C++ para los archivos. De
esta manera nuestra hipotética librería de MP3 podría codificar y decodificar
datos en este formato hacia y desde dichos archivos.</p>
<p>En este punto la cuestión que se nos plantea es ¿qué podríamos hacer si,
por ejemplo, quisiéramos codificar el audio para posteriormente transmitirlo
a otro ordenador a través de una red? Teniendo en cuenta lo comentado hasta
ahora, una opción sería codificarlo almacenándolo en un archivo y posteriormente
leer del mismo para transmitir los datos por la red. Obviamente esto dista
de ser ideal ya que sería preferible disponer de una clase que implementara
la interfaz de <a href="http://www.cplusplus.com/reference/ostream/ostream/" title="std::ostream">std::ostream</a> para almacenar los datos codificados directamente
en la memoria, evitando tener que dar pasos intermedios como guardarlos y
leerlos de un archivo temporal.</p>
<p>Por fortuna la librería estándar de C++ nos provee de las clases:</p>
<dl>
<dt><a href="http://www.cplusplus.com/reference/sstream/istringstream/" title="std::istringstream">std::istringstream</a></dt>
<dd>Flujo de entrada para operar sobre cadenas. Los objetos de esta clase
permiten leer los caracteres del flujo de entrada a partir del contenido
de un objeto <code>std::string</code>.</dd>
<dt><a href="http://www.cplusplus.com/reference/sstream/ostringstream/" title="std::ostringstream">std::ostringstream</a></dt>
<dd>Flujo de salida para operar sobre cadenas. Los objetos de esta clase
permiten escribir los caracteres del flujo de salida en un objeto <code>std::string</code>.</dd>
<dt><a href="http://www.cplusplus.com/reference/sstream/stringstream/" title="std::stringstream">std::stringstream</a></dt>
<dd>Flujo para operar sobre cadenas. Los objetos de esta clase permiten leer
y escribir en un objeto <code>std::string</code>.</dd>
</dl>
<p>ofreciéndonos una forma sencilla de almacenar o leer de la memoria del proceso
los datos codificados en MP3, lo que facilitaría cuaĺquier tarea que quisiéramos
realizar con ellos posteriormente.</p>
<h2>QIODevice</h2>
<p>En el <em>framework</em> <a href="../proyecto-qt-framework-de-desarrollo-de-aplicaciones.html" title="Proyecto Qt">Qt</a> ocurre algo muy parecido. Todas las clases diseñadas
para acceder a dispositivos de entrada/salida reciben un objeto de la clase
<a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a>. Por ejemplo:</p>
<dl>
<dt><a href="http://qt-project.org/doc/qt-5.0/qtcore/qtextstream.html" title="QTextStream">QTextStream</a></dt>
<dd>Proporciona una interfaz adecuada para leer y escribir datos en
formato texto desde un <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a>.</dd>
<dt><a href="http://qt-project.org/doc/qt-5.0/qtcore/qdatastream.html" title="QDataStream">QDataStream</a></dt>
<dd>Proporciona una interfaz adecuada para leer y escribir datos binarios
desde un <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a>.</dd>
<dt><a href="http://qt-project.org/doc/qt-5.0/qtgui/qimagereader.html" title="QImageReader">QImageReader</a></dt>
<dd>Proporciona una interfaz independiente del formato para leer archivos de
imágenes desde un dispositivo <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a>.</dd>
<dt><a href="http://qt-project.org/doc/qt-5.0/qtgui/qimagewriter.html" title="QImageWriter">QImageWriter</a></dt>
<dd>Proporciona una interfaz independiente del formato para escribir archivos de
imágenes desde un dispositivo <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a>.</dd>
<dt><a href="../como-usar-qmovie-en-qt.html" title="QMovie">QMovie</a></dt>
<dd>Es una clase diseñada para reproducir películas leidas con <a href="http://qt-project.org/doc/qt-5.0/qtgui/qimagereader.html" title="QImageReader">QImageReader</a>
desde un <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a>.</dd>
</dl>
<p>La clase <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a> no se instancia directamente para crear objetos, sino que
su función es definir una interfaz genérica válida para todo tipo de
dispositivos de entrada/salida. En el <em>framework</em> <a href="../proyecto-qt-framework-de-desarrollo-de-aplicaciones.html" title="Proyecto Qt">Qt</a> diversas clases
heredan de esta, implementando la interfaz <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a> para un dispositivo
concreto:</p>
<dl>
<dt><a href="http://qt-project.org/doc/qt-5.0/qtnetwork/qtcpsocket.html" title="QTcpSocket">QTcpSocket</a></dt>
<dd>Es una clase heredera de <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a> que permite establecer una conexión
TCP y transferir flujos de datos a través de ella.</dd>
<dt><a href="http://qt-project.org/doc/qt-5.0/qtcore/qfile.html" title="QFile">QFile</a></dt>
<dd>Es una clase heredera de <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a> para leer y escribir archivos de texto
y binarios, así como <a href="http://qt-project.org/doc/qt-5.0/qtcore/resources.html">recursos de la aplicación</a>.</dd>
<dt><a href="http://qt-project.org/doc/qt-5.0/qtcore/qprocess.html" title="QProcess">QProcess</a></dt>
<dd>Es una clase heredera de <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a> que permite ejecutar un programa externo
y comunicarnos con él.</dd>
<dt><a href="http://qt-project.org/doc/qt-5.0/qtcore/qbuffer.html" title="QBuffer">QBuffer</a></dt>
<dd>Es una clase heredera de <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a> que implementa dicha interfaz de
dispositivos sobre un <a href="http://qt-project.org/doc/qt-5.0/qtcore/qbytearray.html" title="QByteArray">QByteArray</a>. Ésta es una clase que provee una interfaz
para manipular un <em>array</em> de bytes en la memoria.</dd>
</dl>
<h2>Ejemplos con imágenes</h2>
<p>Para ilustrar lo comentado vamos a codificar y decodificar una imagen <a href="http://qt-project.org/doc/qt-5.0/qtgui/qimage.html" title="QImage">QImage</a>
directamente desde la memoria.</p>
<h3>Codificando una imagen en la memoria</h3>
<p>Supongamos que <code>image</code> es un objeto <a href="http://qt-project.org/doc/qt-5.0/qtgui/qimage.html" title="QImage">QImage</a> que queremos codificar en formato
PNG, guardando el resultado en un <em>array</em> en la memoria para su procesamiento
posterior (p. ej. para transmitirlo a través de una red de comunicaciones).</p>
<p>Hacerlo es tan sencillo como incorporar las siguientes líneas al programa:</p>
<div class="codehilite"><pre><span class="n">QBuffer</span> <span class="n">buffer</span><span class="p">;</span>
<span class="n">image</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;png&quot;</span><span class="p">);</span>
</pre></div>


<p>Como hemos comentado, <a href="http://qt-project.org/doc/qt-5.0/qtcore/qbuffer.html" title="QBuffer">QBuffer</a> es un clase heredada de <a href="http://qt-project.org/doc/qt-5.0/qtcore/qiodevice.html" title="QIODevice">QIODevice</a>, por lo
que podemos usarla allí donde se requiera un dispositivo de entrada/salida.
Por defecto los objetos de <a href="http://qt-project.org/doc/qt-5.0/qtcore/qbuffer.html" title="QBuffer">QBuffer</a> se crean con un <em>buffer</em> interno de tipo
<a href="http://qt-project.org/doc/qt-5.0/qtcore/qbytearray.html" title="QByteArray">QByteArray</a>, al que podemos acceder directamente invocando el método
<a href="http://qt-project.org/doc/qt-5.0/qtcore/qbuffer.html" title="QBuffer">QBuffer</a>::<a href="http://qt-project.org/doc/qt-5.0/qtcore/qbuffer.html#buffer" title="QBuffer::buffer()">buffer</a>(). Por ejemplo:</p>
<div class="codehilite"><pre><span class="n">QByteArray</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">buffer</span><span class="p">();</span>

<span class="c1">// Guardamos en un string los primeros 6 bytes de la imagen en PNG</span>
<span class="n">string</span> <span class="nf">pngHeader</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="n">constData</span><span class="p">(),</span> <span class="mi">6</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pngHeader</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></div>


<p>lo que mostraría por la salida estándar algo como lo siguiente:</p>
<div class="codehilite"><pre><span class="err">�</span><span class="n">PNG</span>
</pre></div>


<p>Esta forma de guardar los datos es adecuada cuando no necesitamos más control
sobre las opciones del formato en cuestión. Si por el contrario queremos
controlar el nivel de compresión, el de gamma o algunos otros parámetros
específicos del formato, tendremos que emplear un objeto <a href="http://qt-project.org/doc/qt-5.0/qtgui/qimagewriter.html" title="QImageWriter">QImageWriter</a>:</p>
<div class="codehilite"><pre><span class="n">QBuffer</span> <span class="n">buffer</span><span class="p">;</span>
<span class="n">QImageWriter</span> <span class="nf">writer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
<span class="n">writer</span><span class="p">.</span><span class="n">setFormat</span><span class="p">(</span><span class="s">&quot;jpeg&quot;</span><span class="p">);</span>
<span class="n">writer</span><span class="p">.</span><span class="n">setCompression</span><span class="p">(</span><span class="mi">70</span><span class="p">);</span>
<span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="p">)</span><span class="o">:</span>
</pre></div>


<h3>Decodificando una imagen almacenada en la memoria</h3>
<p>Ahora hagámoslo en sentido inverso. Si tenemos un puntero <code>const char *bytes</code>
a una zona de memoria con <code>size</code> bytes donde se almacena una imagen en formato
PNG y queremos cargarla en un objeto <code>QImage</code>, sólo tenemos que asignar los
datos a un objeto <code>QBuffer</code> y leer desde el:</p>
<div class="codehilite"><pre><span class="n">QBuffer</span> <span class="n">buffer</span><span class="p">;</span>
<span class="n">buffer</span><span class="p">.</span><span class="n">setData</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="n">QImage</span> <span class="nf">image</span><span class="p">();</span>
<span class="n">image</span><span class="p">.</span><span class="n">setDevice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
<span class="n">image</span><span class="p">.</span><span class="n">setFormat</span><span class="p">(</span><span class="s">&quot;png&quot;</span><span class="p">);</span>
<span class="n">image</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
</pre></div>


<p>o lo que es equivalente y mucho más simple:</p>
<div class="codehilite"><pre><span class="n">QBuffer</span> <span class="n">buffer</span><span class="p">;</span>
<span class="n">buffer</span><span class="p">.</span><span class="n">setData</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="n">image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;png&quot;</span><span class="p">);</span>
</pre></div>


<h2>Referencias</h2>
<ol>
<li><a href="http://qt-project.org/doc/qt-5.0/qtcore/qbuffer.html" title="QBuffer">QBuffer</a>.</li>
<li><a href="http://qt-project.org/doc/qt-5.0/qtcore/qbytearray.html" title="QByteArray">QByteArray</a>.</li>
<li><a href="http://qt-project.org/doc/qt-5.0/qtgui/qimage.html" title="QImage">QImage</a>.</li>
<li><a href="http://qt-project.org/doc/qt-5.0/qtgui/qimagereader.html" title="QImageReader">QImageReader</a>.</li>
<li><a href="http://qt-project.org/doc/qt-5.0/qtgui/qimagewriter.html" title="QImageWriter">QImageWriter</a>.</li>
</ol></div>
        <hr />
    </div>
		
            <div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Anterior</a></li>

    <li class="active"><a href="../tag/qiodevice.html">1</a></li>

    <li class="next disabled"><a href="#">&rarr; Siguiente</a></li>

</ul>
</div>    
 
  
        </div>
        
        <div class="span3">

            
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Sitio
                </li>
            
                <li><a href="../archives.html">Archivos</a>
                <li><a href="../tags.html">Etiquetas</a>
                <li><a href="http://ull-etsii-sistemas-operativos.github.io/videovigilancia-blog/feeds/atom.xml" rel="alternate">Fuente Atom</a></li>
                                <li><a href="http://ull-etsii-sistemas-operativos.github.io/videovigilancia-blog/feeds/rss.xml" rel="alternate">Fuente RSS</a></li>
                            </ul>
            </div>


                        <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categorias
                </li>
                
                                <li><a href="../category/comunicaciones.html">Comunicaciones</a></li>
                                <li><a href="../category/hardware.html">Hardware</a></li>
                                <li><a href="../category/linux.html">Linux</a></li>
                                <li><a href="../category/overviews.html">Overviews</a></li>
                                <li><a href="../category/qt.html">Qt</a></li>
                                <li><a href="../category/vision.html">Visión</a></li>
                                   
            </ul>
            </div>
            

            

                        <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                                <li><a href="http://github.com/ull-etsii-sistemas-operativos/">github</a></li>
                                <li><a href="http://plus.google.com/u/0/communities/112085352199958768374">google+</a></li>
                                <li><a href="http://flattr.com/thing/1171169/Sistema-de-videovigilancia-from-scratch">flattr</a></li>
                                <li><a href="http://ull-etsii-sistemas-operativos.github.io/videovigilancia-blog/feeds/atom.xml">atom</a></li>
                                <li><a href="http://ull-etsii-sistemas-operativos.github.io/videovigilancia-blog/feeds/rss.xml">rss</a></li>
                            </ul>
            </div>
            </div>
            
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
<ul class="nav nav-list">
    <li class="nav-header">
    Búsqueda de Google
    </li>

    <script type="text/javascript">
    (function() {
    var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.es/cse/cse.js?cx=' + '013894742475483232300:q2-5a1zlira';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
    })();
    </script>
    <gcse:search>Cargando...</gcse:search>
</ul>
</div>

        </div>  
    </div>     </div> 
<footer>
<br />
<p><a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.es"><img alt="Licencia Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/80x15.png" /></a><br />Este obra está bajo una <a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.es">Licencia Creative Commons Atribución 3.0 Unported</a>.</p>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>
 
</body>
</html>